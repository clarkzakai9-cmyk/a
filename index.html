<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano AI: Qwen 0.5B Offline</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 700px; margin: 20px auto; padding: 20px; background: #fafafa; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eaeaea; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #status { font-size: 13px; color: #666; margin-bottom: 8px; }
        .progress-bar { width: 100%; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
        #progress-inner { width: 0%; height: 100%; background: #4caf50; transition: width 0.3s; }
        #chat-box { height: 300px; border: 1px solid #f0f0f0; border-radius: 8px; padding: 15px; overflow-y: auto; background: #fff; margin-bottom: 15px; }
        textarea { width: 100%; height: 60px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: none; box-sizing: border-box; font-size: 14px; }
        button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #load-btn { background: #4caf50; color: white; }
        #send-btn { background: #2196f3; color: white; }
        button:disabled { background: #e0e0e0; cursor: not-allowed; color: #999; }
        .msg { margin-bottom: 15px; font-size: 14px; line-height: 1.5; }
        .user { color: #333; font-weight: bold; }
        .ai { color: #2196f3; background: #f0f7ff; padding: 8px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="card">
    <h3>Qwen 2.5 (0.5B) Local AI</h3>
    <p style="font-size: 12px; color: #999;">Small & Fast: Only ~400MB download. Runs offline after first load.</p>
    
    <div id="status">Status: Ready</div>
    <div class="progress-bar"><div id="progress-inner"></div></div>
    
    <button id="load-btn">Download AI to Browser</button>

    <div id="chat-box"></div>
    
    <textarea id="user-input" placeholder="Type a message..." disabled></textarea>
    <button id="send-btn" disabled>Send Message</button>
</div>

<script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    // Register Service Worker for true offline access
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
    }

    const statusLabel = document.getElementById("status");
    const progressInner = document.getElementById("progress-inner");
    const loadBtn = document.getElementById("load-btn");
    const sendBtn = document.getElementById("send-btn");
    const userInput = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");

    // MODEL CHOICE: Qwen2.5-0.5B (Tiny & Smart)
    const modelId = "Qwen2.5-0.5B-Instruct-q4f16_1-MLC";
    let engine;

    loadBtn.onclick = async () => {
        loadBtn.disabled = true;
        statusLabel.innerText = "Downloading model weights...";

        try {
            engine = await webllm.CreateMLCEngine(modelId, {
                initProgressCallback: (report) => {
                    statusLabel.innerText = report.text;
                    progressInner.style.width = (report.progress * 100) + "%";
                }
            });
            statusLabel.innerText = "AI Ready! You can go offline now.";
            sendBtn.disabled = false;
            userInput.disabled = false;
        } catch (err) {
            statusLabel.innerText = "WebGPU Error: " + err.message;
            loadBtn.disabled = false;
        }
    };

    sendBtn.onclick = async () => {
        const text = userInput.value.trim();
        if (!text) return;

        chatBox.innerHTML += `<div class="msg"><span class="user">You:</span> ${text}</div>`;
        userInput.value = "";
        
        const aiDiv = document.createElement("div");
        aiDiv.className = "msg ai";
        aiDiv.innerHTML = "Thinking...";
        chatBox.appendChild(aiDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        const messages = [{ role: "user", content: text }];
        const reply = await engine.chat.completions.create({ messages });
        
        aiDiv.innerHTML = `<b>AI:</b> ${reply.choices[0].message.content}`;
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>

</body>
</html>
